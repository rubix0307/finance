{% load i18n %}
<script>
  window.currencyUpdater = function() {
    return {
      async saveCurrency() {
        const currencyStore = Alpine.store('currency');
        const appData = Alpine.store('appData');
        const selectedCurrency = currencyStore.selectedCurrency;
        if (!selectedCurrency) {
          return;
        }
        const currentSection = appData.current_section;
        const me = appData.me;
        if (!currentSection || !me) {
          return;
        }
        const url = `/api/sections/${currentSection.id}/memberships/${me.id}/`;
        const csrfToken = getCookie('csrftoken');

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken, },
            body: JSON.stringify({ currency: selectedCurrency.code }),
          });
          if (!response.ok) {
            throw new Error(`Ошибка: ${response.status}`);
          }
          const updatedUserData = await response.json();
          if (currentSection.users && Array.isArray(currentSection.users)) {
            const userIndex = currentSection.users.findIndex(u => u.id === updatedUserData.id);
            if (userIndex !== -1) {
              currentSection.users.splice(userIndex, 1, { ...currentSection.users[userIndex], ...updatedUserData });
              appData.current_section = { ...currentSection };
            }
          }
          currencyStore.selectedCurrency = null;
        } catch (error) {
          console.error('Ошибка при сохранении валюты:', error);
        }
      }
    }
  };
</script>

<div class="blocks" x-data="currencyUpdater()">
  <div
    x-data
    x-init="Alpine.store('currency').init()"
    class="main_block menu currency"
    :style="Alpine.store('currency').open ? 'padding-bottom: 5px;' : ''"
  >
    <div class="head" @click="Alpine.store('currency').currencyToggle()">
      <div class="title">{% trans 'Currency' %}:</div>
      <div class="name">
        <div x-text="Alpine.store('currency').getCurrentCurrency?.code || '—'"></div>
        <div class="arrow fleep" :class="{ 'fleep180x': Alpine.store('currency').open }">
          <template x-if="Alpine.store('currency').getCurrentCurrency?.code">
            {% include 'svg/arrow_down.svg' %}
          </template>
        </div>
      </div>
    </div>

    <div x-show="Alpine.store('currency').open" class="choose" x-transition>
      <div class="info">*{% trans 'to display charts' %}</div>
      <div class="search">
        <div class="id">{% include 'svg/search.svg' %}</div>
        <input
          type="search"
          inputmode="search"
          enterkeyhint="search"
          placeholder="{% trans 'Code of currency' %}"
          x-model="Alpine.store('currency').query"
        >
      </div>

      <div class="groups" x-ref="currencyList">
        <template x-for="currency in Alpine.store('currency').getFilteredCurrencies" :key="currency.code">
          <div
            class="option_group"
            :class="{
              'active': currency.code === Alpine.store('currency').getCurrentCurrency?.code,
              'choose': currency.code === Alpine.store('currency').selectedCurrency?.code
            }"
            @click="Alpine.store('currency').setSelectedCurrency(currency)"
          >
            <div class="code" x-text="currency.code"></div>
          </div>
        </template>
      </div>
    </div>
  </div>

  <div class="main_block save"
       x-show="Alpine.store('currency').selectedCurrency && Alpine.store('currency').selectedCurrency.code !== Alpine.store('currency').getCurrentCurrency?.code && Alpine.store('currency').open"
       @click="saveCurrency()">
    {% trans 'Save' %}
  </div>
</div>
{##}
{#<script>#}
{#  document.addEventListener('alpine:init', () => {#}
{#    Alpine.store('appData', {#}
{#      sections: [],#}
{#      currencies: [],#}
{#      current_section: null,#}
{#      me: {},#}
{##}
{#    });#}
{##}
{#    Alpine.store('currency', {#}
{#      open: false,#}
{#      query: '',#}
{#      isReady: false,#}
{#      selectedCurrency: null,#}
{#      init() {#}
{#        Alpine.watch(() => Alpine.store('appData').currencies, (currencies) => {#}
{#          if (currencies && currencies.length) {#}
{#            this.isReady = true;#}
{#            Alpine.watch(() => Alpine.store('appData').current_section, () => {#}
{#              queueMicrotask(() => {#}
{#                document.querySelector('[x-ref="currencyList"]')?.scrollTo({ top: 0, behavior: 'auto' });#}
{#              });#}
{#            });#}
{#          }#}
{#        });#}
{#      },#}
{#      currencyToggle() {#}
{#        if (!this.isReady) return;#}
{#        this.open = !this.open;#}
{#        if (!this.open) this.query = '';#}
{#        document.querySelector('[x-ref="currencyList"]')?.scrollTo({ top: 0, behavior: 'auto' });#}
{#      },#}
{#      setSelectedCurrency(currency) {#}
{#        if (#}
{#          (this.selectedCurrency && this.selectedCurrency.code === currency.code) ||#}
{#          (this.getCurrentCurrency && this.getCurrentCurrency.code === currency.code)#}
{#        ) {#}
{#          this.selectedCurrency = null;#}
{#        } else {#}
{#          this.selectedCurrency = currency;#}
{#        }#}
{#      }#}
{#    });#}
{##}
{#    Object.defineProperty(Alpine.store('currency'), 'getCurrentCurrency', {#}
{#      get() {#}
{#        const currentSection = Alpine.store('appData').current_section;#}
{#        const me = Alpine.store('appData').me;#}
{#        const sectionMe = currentSection?.users.find(user => user.id === me.id);#}
{#        return sectionMe?.currency || null;#}
{#      }#}
{#    });#}
{##}
{#    Object.defineProperty(Alpine.store('currency'), 'getFilteredCurrencies', {#}
{#      get() {#}
{#        if (!Alpine.store('currency').isReady) return [];#}
{#        const all = Alpine.store('appData').currencies || [];#}
{#        const query = Alpine.store('currency').query.toLowerCase();#}
{#        const current = Alpine.store('currency').getCurrentCurrency;#}
{#        let filtered = all.filter(c =>#}
{#          c.code.toLowerCase().includes(query) &&#}
{#          (!current || c.code !== current.code)#}
{#        );#}
{#        if (current && current.code.toLowerCase().includes(query)) {#}
{#          return [current, ...filtered];#}
{#        }#}
{#        return filtered;#}
{#      }#}
{#    });#}
{#  });#}
{#</script>#}